version: 2.1

git_restore_cache: &git_restore_cache
  restore_cache:
    keys:
      - source-v1-{{ .Branch }}-{{ .Revision }}
      - source-v1-{{ .Branch }}-
      - source-v1-

git_save_cache: &git_save_cache
  save_cache:
    key: source-v1-{{ .Branch }}-{{ .Revision }}
    paths:
      - ".git"

npm_restore_cache: &npm_restore_cache
  restore_cache:
    keys:
      - npm-v1-{{ checksum "_generator/package-lock.json" }}
      - npm-v1-

npm_save_cache: &npm_save_cache
  save_cache:
    key: npm-v1-{{ checksum "_generator/package-lock.json" }}
    paths:
      - node_modules



nightly:
  triggers:
    - schedule:
        cron: "15 0,2,4,6,8,10,12,14,16,18,20,22 * * *"
        filters:
          branches:
            only:
              - gh-pages


jobs:
  build:
    docker:
      - image: 'circleci/node:14'
    steps:
      - *git_restore_cache
      - checkout
      - *git_save_cache
      - run: npm ci
      - *npm_save_cache
      - run: node _generator/bin scrape generate
      - run: git add .
      - run: git commit -q -m "CI Build" > /dev/null
      - run: git push origin gh-pages -q


